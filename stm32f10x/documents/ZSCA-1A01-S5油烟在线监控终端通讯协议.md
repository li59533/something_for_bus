## ZSCA-1A01-S5油烟在线监控终端通讯协议

修订记录

| 版本 |    时间    | 说明                                    |
| :--: | :--------: | --------------------------------------- |
| V1.0 | 2018-10-10 | 初次发布                                |
| V1.1 | 2018-10-18 | 修改的蓝牙配置包格式；修改了FCF字段定义 |



### 1、本地配置通讯协议

本地配置通讯协议适用于蓝牙配置设备参数。蓝牙连接方式采用经典蓝牙SPP协议。数据通讯协议格式如下：

#### 1.1 协议包格式

协议格式如下，数据传输默认采用小端模式，个别另有说明除外。

```
typedef struct
{
    uint8_t 	Header; // 帧头，固定为0x5A
    uint16_t 	Length; // 数据包总长度，从Header到Footer
    {
        uint16_t  FCF;	// 帧控制域
        uint8_t  Seq;	// 序列号
        uint16_t Model;	// 设备型号，发送者的
        uint32_t DeviceId;	// 设备ID，发送者的
        uint8_t  Addr;		// 主机查询时，填对方地址，从机应答时填自己地址,0xFF表示广播，0x00表示不用关心
        {
            uint8_t Cmd; // 命令类型
            uint8_t *CmdPayload; // 命令内容 
        }
    }
    uint8_t FCS; // 帧校验，累加和校验，从Length到CmdPayload
    uint8_t Footer; // 帧尾，固定为0x53
}ZSProto_t;
```

其中帧控制域（FCF）格式如下（该字段暂时设为16384）

```
bit0:Ack_Req; 
bit1:Sec;
bit2:Pending;
bit3:Trans;
bit4~bit5:保留
bit6~bit7:FrameType;
bit8~bit10:保留;
bit11:Gateway;
bit12~bit15:ConnType;
```

本设备Model固定为10

本设备交互支持以下命令

```
typedef enum
{
    ZSCmd_ConfigGetReq = 128,  // 获取获取请求
    ZSCmd_ConfigGetResp = 129, // 配置获取应答
    ZSCmd_ConfigSetReq = 130,  // 配置设置请求
    ZSCmd_ConfigSetResp = 131, // 配置设置应答
}ZSCmd_e;
```

#### 1.2 配置获取请求

```
Cmd:ZSCmd_ConfigGetReq
CmdPayload:无该字段
```

参考示例：

```
5A 10 00 00 00 01 0A 00 12 23 34 45 00 80 49 53表示获取配置请求，其中
5A-帧头
10 00-表示数据包长度为16（0x0010）
00 00 -表示FCF帧控制域
01-表示Seq，序列号
0A 00-表示设备型号代码为10（0x000A）
12 23 34 45-表示设备ID为1161044754（0x45342312）
00-表示地址
80-表示ZSCmd_ConfigGetReq命令128（0x80）
49-表示和校验
53-表示帧尾
```



#### 1.3 配置获取应答

```
Cmd:ZSCmd_ConfigGetResp
CmdPayload：
{
    uint8_t TLVCount; // 该字段用于指示后面的TLV编码数据的个数
    TLVUnit_t TLVData[TLVCount]; //TLV编码格式数据（见1.6章节介绍），返回当前所有配置信息
}
```

参考示例:

```
5A BC 00 00 03 00 20 00 00 00 00 00 81 1D 00 01 05 01 01 01 02 02 05 00 03 02 01 00 04 02 01 00 05 01 12 06 04 34 12 00 00 07 04 12 12 00 00 08 04 00 00 00 00 09 06 5A 53 50 4C 41 54 0A 01 00 0B 02 20 4E 0C 04 84 E8 00 00 0D 0E 77 77 77 2E 6E 6A 7A 68 68 62 2E 63 6F 6D 0E 01 00 0F 01 00 10 02 20 4E 11 04 84 E8 67 12 12 0E 12 12 77 2E 6E 6A 7A 68 68 62 2E 63 6F 6D 13 01 01 14 01 01 15 02 25 4E 16 04 84 E8 67 12 17 0E 77 77 77 2E 6E 6A 7A 68 68 62 2E 63 6F 6D 18 01 00 19 01 00 1A 02 21 4E 1B 04 84 E8 67 12 1C 0E 77 77 77 2E 6E 6A 7A 68 68 62 2E 63 6F 6D EF 53 表示配置获取应答
其中
5A -Header
BC 00 -Length:188(0x00BC)
00 -FCF
03 -Seq
00 20 - Model:8192(0x2000)
00 00 00 00 -DeviceId:0
00 -Addr
81 -Cmd:ZSCmd_ConfigGetResp：129(0x81)
1D -TLVCount:29，表示后续有29个TLV数据编码的数据段
00 01 05 -Tag:0,Len:1,Value:5
01 01 01 -Tag:1,Len:1,Value:1
02 02 05 00 -Tag:2,Len:2,Value:0x0005
03 02 01 00 
04 02 01 00 
05 01 12 
06 04 34 12 00 00 
07 04 12 12 00 00 
08 04 00 00 00 00 
09 06 5A 53 50 4C 41 54 
0A 01 00 
0B 02 20 4E 
0C 04 84 E8 00 00 
0D 0E 77 77 77 2E 6E 6A 7A 68 68 62 2E 63 6F 6D 
0E 01 00 
0F 01 00 
10 02 20 4E -Tag:16,Len:2,Value:表示端口20000(0x4E20)
11 04 84 E8 67 12 -Tag:11,Len:4,Value:表示IP为132.232.103.18
12 0E 12 12 77 2E 6E 6A 7A 68 68 62 2E 63 6F 6D -Tag:12,Len:14,Value:字符串格式表示www.njzhhb.com
13 01 01 
14 01 01 
15 02 25 4E 
16 04 84 E8 67 12 
17 0E 77 77 77 2E 6E 6A 7A 68 68 62 2E 63 6F 6D 
18 01 00 
19 01 00 
1A 02 21 4E 
1B 04 84 E8 67 12 
1C 0E 77 77 77 2E 6E 6A 7A 68 68 62 2E 63 6F 6D 
EF -和校验 // 此校验码有误
53 -Footer
```

#### 1.4 配置设置请求

```
Cmd:ZSCmd_ConfigSetReq
CmdPayload：
{
    uint8_t TLVCount; // 该字段用于指示后面的TLV编码数据的个数
    TLVUnit_t TLVData[TLVCount]; //TLV编码格式数据（见1.6章节介绍），返回当前所有配置信息
}
```

#### 1.5 配置设置应答

```
Cmd:ZSCmd_ConfigSetResp
CmdPayload：
{
	uint8_t Result; // 配置设置结果，0-有参数配置失败，1-配置成功
	uint8_t TLVCount; // 该字段用于指示后面的TLV编码数据的个数
	TLVUnit_t TLVData[TLVCount]; // 修改后的参数，TLV编码格式数据（见1.6章节介绍），返回当前所有配置信息    
}
```

#### 1.6 配置包数据格式

配置包数据CmdPayload格式采用TLV编码格式，其中T占用一个字节，L占用一个字节，**所有Value字段如无单独说明，均为数字，非ASCII码格式字符串**。


| Tag  | Length | Value                                                     | 备注                                                         |
| :--: | :----: | :-------------------------------------------------------- | ------------------------------------------------------------ |
|  0   |   1    | 取值范围：0~5                                             | 开关检测模式。0-风机关联净化器状态，净化器检测电流；1-风机关联净化器状态，净化器检测开关；2-风机检测电流，净化器检测电流；3-风机检测开关，净化器检测开关；4-风机检测电流，净化器检测开关；5-风机检测开关，净化器检测电流; |
|  1   |   1    | 取值范围：0~2                                             | 浓度探头数量                                                 |
|  2   |   2    | 取值范围：5~3600                                          | 上报间隔，单位：秒                                           |
|  3   |   2    | 取值范围：1~65535                                         | 净化器电流互感器变比                                         |
|  4   |   2    | 取值范围：1~65535                                         | 风机电流互感器变比                                           |
|  5   |   1    | 取值范围：0~255                                           | HJ212 EPC Head                                               |
|  6   |   4    | 取值范围：0~268435456                                     | HJ212 EPC  厂商识别代码                                      |
|  7   |   4    | 取值范围：0~16777216                                      | HJ212 EPC 对象分类代码                                       |
|  8   |   4    | 取值范围：0~4294967296                                    | HJ212 EPC 序列号（设备ID）                                   |
|  9   |   6    | 数字或字母                                                | HJ212访问密码                                                |
|  10  |   1    | 0-使用IP连接；1-使用域名连接                              | 主服务器域名使能标志                                         |
|  11  |   2    | 取值范围：1~65535                                         | 主服务器端口                                                 |
|  12  |   4    | 十六进制格式有效IP地址（示例：0xC0A80001表示192.168.0.1） | 主服务IP                                                     |
|  13  |  <=50  | 域名字符串内容                                            | 主服务器域名                                                 |
|  14  |   1    | 0-无备用服务器；1-使用备份服务器                          | 备用服务器使能标志                                           |
|  15  |   1    | 0-使用IP连接；1-使用域名连接                              | 备用服务器域名使能标志                                       |
|  16  |   2    | 取值范围：1~65535                                         | 备用服务器端口                                               |
|  17  |   4    | 十六进制格式有效IP地址（示例：0xC0A80001表示192.168.0.1） | 备用服务器IP                                                 |
|  18  |  <=50  | 域名字符串内容                                            | 备用服务器域名                                               |
|  19  |   1    | 0-无钩子服务器；1-使用钩子服务器                          | 钩子服务器使能标志                                           |
|  20  |   1    | 0-使用IP连接；1-使用域名连接                              | 钩子服务器域名使能标志                                       |
|  21  |   2    | 取值范围：1~65535                                         | 钩子服务器端口                                               |
|  22  |   4    | 十六进制格式有效IP地址（示例：0xC0A80001表示192.168.0.1） | 钩子服务器IP                                                 |
|  23  |  <=50  | 域名字符串内容                                            | 钩子服务器域名                                               |
|  24  |   1    | 0-无钩子备用服务器；1-使用钩子备份服务器                  | 钩子备用服务器使能标志                                       |
|  25  |   1    | 0-使用IP连接；1-使用域名连接                              | 钩子备用服务器域名使能标志                                   |
|  26  |   2    | 取值范围：1~65535                                         | 钩子备用服务器端口                                           |
|  27  |   4    | 十六进制格式有效IP地址（示例：0xC0A80001表示192.168.0.1） | 钩子备用服务器IP                                             |
|  28  |  <=50  | 域名字符串内容                                            | 钩子备用服务器域名                                           |

​	

### 2、GPRS通讯协议

GPRS通讯采用HJ212-2017污染物在线监控（监测）系统数据传输标准 。

#### 2.1 对时命令

设备主动发送对时请求命令，参见标准HJ212-2017命令示例。

注：由于直接对采集设备进行对时，`现场机时间校准请求 ` ，`设置现场机时间 ` 命令无需PolId字段。以下其他命令都不包含PolId字段。

#### 2.2 数据上报

CP字段格式如下：

  ```
g75001-RS=1;g75101-RS=0,g75101-Rtd=102;a34013-Rtd=0.025,a34013-Flag=N,a34013-EFlag=OUT;a34013-Rtd=0.125,a34013-Flag=N,a34013-EFlag=IN
  ```

其中

* `g75001-RS` 表示风机开关状态，0-关，1-开。
* `g75101-RS` 表示净化器开关状态，0-关，1-开。

* `g75101-Rtd` 表示净化器电流，单位mA。

* `a34013-Rtd` 表示油烟浓度值。

* `a34013-Flag` 表示油烟浓度探头工作状态，N表示工作正常，B表示浓度探头工作异常。
* `a34013-EFlag` 表示进口油烟浓度还是出口油烟浓度，IN表示入口浓度，OUT表示出口浓度。

实际工作中，上报数据是否包含`a34013` 相关字段取决于设备是否安装了油烟浓度探头及安装的数据量。如果有则包含该字段，如果没有则不包含该字段。

#### 2.3 参数配置

CP字段各参数编码定义如下：

```
i13020-Info   // 主服务器域名使能
i13021-Info   // 主服务器IP
i13022-Info   // 主服务器域名
i13023-Info   // 主服务器端口
i13024-Info   // 备份服务器使能
i13025-Info   // 备份服务器域名使能
i13026-Info   // 备份服务器IP
i13027-Info   // 备份服务器域名
i13028-Info   // 备份服务器端口
i13029-Info   // 发送间隔
i13030-Info   // HJ212 EPC SEQ （同时作为设备ID使用）
```

